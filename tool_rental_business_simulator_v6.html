<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∏–∑–Ω–µ—Å-—Å–∏–º—É–ª—è—Ç–æ—Ä —Å AI-–ø–æ–º–æ—â–Ω–∏–∫–æ–º | –ü—Ä–æ–∫–∞—Ç –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .header-gradient { background: linear-gradient(90deg, #1e3a8a 0%, #3b82f6 100%); }
        .kpi-card { background-color: #fff; border-radius: 0.75rem; padding: 1.25rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); text-align: center; }
        .chart-container { position: relative; height: 250px; background-color: #fff; padding: 1rem; border-radius: 0.75rem; box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        h2 { color: #111827; font-weight: 700; font-size: 1.25rem; }
        h3 { color: #1e3a8a; font-weight: 600; font-size: 1.1rem; border-bottom: 2px solid #dbeafe; padding-bottom: 0.5rem; margin-bottom: 1rem; }
        .ai-button { background-color: #4f46e5; color: white; border: none; padding: 0.5rem 1rem; border-radius: 0.5rem; font-weight: 500; transition: background-color 0.2s; cursor: pointer; }
        .ai-button:hover:not(:disabled) { background-color: #4338ca; }
        .ai-button:disabled { background-color: #a5b4fc; cursor: not-allowed; }
        .spinner { border-top-color: #3b82f6; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .toggle-label { display: inline-block; cursor: pointer; }
        .toggle-input { display: none; }
        .toggle-slider { position: relative; display: block; width: 50px; height: 28px; background-color: #ccc; border-radius: 28px; transition: background-color 0.2s; }
        .toggle-slider::before { content: ''; position: absolute; top: 4px; left: 4px; width: 20px; height: 20px; background-color: white; border-radius: 50%; transition: transform 0.2s; }
        .toggle-input:checked + .toggle-slider { background-color: #2563eb; }
        .toggle-input:checked + .toggle-slider::before { transform: translateX(22px); }
        .info-icon { cursor: pointer; color: #60a5fa; font-weight: bold; display: inline-block; margin-left: 8px; }
        .info-box { background-color: #eff6ff; border-left: 4px solid #3b82f6; padding: 12px; margin-top: 8px; border-radius: 4px; font-size: 0.875rem; color: #1e40af; }
        .summary-box { background-color: #f3f4f6; padding: 0.75rem; border-radius: 0.5rem; text-align: center; margin-top: 1rem; }
        .summary-box .label { font-size: 0.875rem; color: #4b5563; }
        .summary-box .value { font-size: 1.125rem; font-weight: 700; color: #1e3a8a; }
    </style>
</head>
<body class="text-gray-800">

    <header class="header-gradient text-white shadow-md mb-6">
        <div class="container mx-auto px-6 py-4"><h1 class="text-2xl font-bold">–ë–∏–∑–Ω–µ—Å-—Å–∏–º—É–ª—è—Ç–æ—Ä: –ü—Ä–æ–∫–∞—Ç –ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞</h1></div>
    </header>

    <main class="container mx-auto px-4 md:px-6">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 space-y-4 bg-white p-4 rounded-xl shadow-sm">
                <h2 class="text-center mb-2">–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–¥–µ–ª–∏</h2>
                <div>
                    <h3>–ë–∏–∑–Ω–µ—Å-–º–æ–¥–µ–ª—å <span class="info-icon" data-target="info-biz-model">‚ìò</span></h3>
                    <div class="info-box hidden" id="info-biz-model">–í—ã–±–µ—Ä–∏—Ç–µ, –∫–∞–∫ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤–∞—à –±–∏–∑–Ω–µ—Å. "–ß–∏—Å—Ç–∞—è –∞—Ä–µ–Ω–¥–∞" ‚Äî –∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –ø—Ä–æ–∫–∞—Ç. "–ì–∏–±—Ä–∏–¥" ‚Äî –µ—Å–ª–∏ —É –≤–∞—Å —Å—Ç—Ä–æ–π—Ñ–∏—Ä–º–∞, –∏ –≤—ã —Å–¥–∞–µ—Ç–µ –ø—Ä–æ—Å—Ç–∞–∏–≤–∞—é—â–∏–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç.</div>
                    <div class="p-3 bg-gray-50 rounded-lg">
                        <div class="flex items-center justify-between"><span class="font-medium text-gray-700">–°—Ç—Ä–æ–π—Ñ–∏—Ä–º–∞ + –ê—Ä–µ–Ω–¥–∞ (–ì–∏–±—Ä–∏–¥)</span><label class="toggle-label"><input type="checkbox" id="hybridModelToggle" class="toggle-input"><span class="toggle-slider"></span></label></div>
                        <div id="downtimeSettings" class="hidden mt-3">
                             <label for="downtimeSlider" class="text-sm font-medium">–ü—Ä–æ—Ü–µ–Ω—Ç –ø—Ä–æ—Å—Ç–æ—è <span class="info-icon" data-target="info-downtime">‚ìò</span></label>
                             <div class="info-box hidden" id="info-downtime">–£–∫–∞–∂–∏—Ç–µ, –∫–∞–∫—É—é —á–∞—Å—Ç—å –≤—Ä–µ–º–µ–Ω–∏ –≤–∞—à –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç —Å–≤–æ–±–æ–¥–µ–Ω –∏ –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–¥–∞–Ω –≤ –∞—Ä–µ–Ω–¥—É.</div>
                             <div class="flex items-center space-x-2"><input type="range" id="downtimeSlider" min="10" max="90" value="40" class="w-full"><span id="downtimeValue" class="text-blue-700 font-bold"></span></div>
                        </div>
                    </div>
                </div>
                <div id="investments">
                    <h3>–ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ (CAPEX) <span class="info-icon" data-target="info-capex">‚ìò</span></h3>
                    <div class="info-box hidden" id="info-capex">–ó–¥–µ—Å—å –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è. –£–∫–∞–∂–∏—Ç–µ, –∫–∞–∫–æ–π –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∏ –≤ –∫–∞–∫–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∑–∞–∫—É–ø–∏—Ç—å –¥–ª—è —Å—Ç–∞—Ä—Ç–∞.</div>
                    <div id="tool-categories"></div>
                    <div class="summary-box"><div class="label">–û–±—â–∏–µ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏</div><div class="value" id="totalCapexSummary"></div></div>
                </div>
                <div id="opex">
                    <h3>–†–∞—Å—Ö–æ–¥—ã –≤ –º–µ—Å—è—Ü (OPEX) <span class="info-icon" data-target="info-opex">‚ìò</span></h3>
                    <div class="info-box hidden" id="info-opex">–≠—Ç–æ –≤–∞—à–∏ —Ä–µ–≥—É–ª—è—Ä–Ω—ã–µ –µ–∂–µ–º–µ—Å—è—á–Ω—ã–µ —Ç—Ä–∞—Ç—ã: –∞—Ä–µ–Ω–¥–∞, –∑–∞—Ä–ø–ª–∞—Ç—ã —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–∞–º –∏ —Ä–∞—Å—Ö–æ–¥—ã –Ω–∞ –ø—Ä–∏–≤–ª–µ—á–µ–Ω–∏–µ –∫–ª–∏–µ–Ω—Ç–æ–≤.</div>
                    <div class="space-y-2 text-sm">
                         <div><label>–ê—Ä–µ–Ω–¥–∞ –ø–æ–º–µ—â–µ–Ω–∏—è, ‚ÇΩ</label><input type="number" id="rentCost" value="75000" class="w-full mt-1 p-2 border rounded-md"></div>
                         <div><label>–°–æ—Ç—Ä—É–¥–Ω–∏–∫–∏, —á–µ–ª.</label><input type="number" id="employeesCount" value="4" class="w-full mt-1 p-2 border rounded-md"></div>
                         <div><label>–°—Ä–µ–¥–Ω—è—è –ó–ü, ‚ÇΩ</label><input type="number" id="avgSalary" value="60000" class="w-full mt-1 p-2 border rounded-md"></div>
                         <div><label>–ú–∞—Ä–∫–µ—Ç–∏–Ω–≥, ‚ÇΩ</label><input type="number" id="marketingCost" value="40000" class="w-full mt-1 p-2 border rounded-md"></div>
                    </div>
                    <div class="summary-box"><div class="label">–ò—Ç–æ–≥–æ –ø–æ—Å—Ç–æ—è–Ω–Ω—ã—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –≤ –º–µ—Å—è—Ü</div><div class="value" id="totalOpexSummary"></div></div>
                </div>
                <div id="assumptions">
                    <h3>–î–æ–ø—É—â–µ–Ω–∏—è <span class="info-icon" data-target="info-assumptions">‚ìò</span></h3>
                    <div class="info-box hidden" id="info-assumptions">–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã, –≤–ª–∏—è—é—â–∏–µ –Ω–∞ —Ä–∞—Å—á–µ—Ç —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏: –ø—Ä–æ—Ü–µ–Ω—Ç –æ—Ç –≤—ã—Ä—É—á–∫–∏ –Ω–∞ —Ä–µ–º–æ–Ω—Ç –∏ –≤–∞—à–∞ —Å–∏—Å—Ç–µ–º–∞ –Ω–∞–ª–æ–≥–æ–æ–±–ª–æ–∂–µ–Ω–∏—è.</div>
                    <div class="space-y-2 text-sm">
                        <div><label>–†–µ–º–æ–Ω—Ç (% –æ—Ç –≤—ã—Ä—É—á–∫–∏)</label><input type="number" id="repairCostPercent" value="5" class="w-full mt-1 p-2 border rounded-md"></div>
                        <div><label>–ù–∞–ª–æ–≥ –£–°–ù –î-–†, %</label><input type="number" id="taxRate" value="15" class="w-full mt-1 p-2 border rounded-md"></div>
                    </div>
                </div>
            </div>
            <div class="lg:col-span-2 space-y-6">
                <div>
                    <h2 class="text-center mb-4">–ö–ª—é—á–µ–≤—ã–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã <span class="info-icon" data-target="info-kpi">‚ìò</span></h2>
                    <div class="info-box hidden" id="info-kpi">
                        <p><strong>NPV (–ß–∏—Å—Ç–∞—è –ø—Ä–∏–≤–µ–¥–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å):</strong> –ì–ª–∞–≤–Ω—ã–π –ø–æ–∫–∞–∑–∞—Ç–µ–ª—å. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, —Å–∫–æ–ª—å–∫–æ –¥–µ–Ω–µ–≥ –ø—Ä–æ–µ–∫—Ç –ø—Ä–∏–Ω–µ—Å–µ—Ç —Å–≤–µ—Ä—Ö –≤—Å–µ—Ö –∑–∞—Ç—Ä–∞—Ç. –ï—Å–ª–∏ –±–æ–ª—å—à–µ –Ω—É–ª—è ‚Äî –ø—Ä–æ–µ–∫—Ç –≤—ã–≥–æ–¥–µ–Ω.</p>
                        <p><strong>–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å:</strong> –ß–µ—Ä–µ–∑ —Å–∫–æ–ª—å–∫–æ –º–µ—Å—è—Ü–µ–≤ –≤–∞—à–∏ –¥–æ—Ö–æ–¥—ã –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–∫—Ä–æ—é—Ç –ø–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω—ã–µ –≤–ª–æ–∂–µ–Ω–∏—è.</p>
                        <p><strong>–ü—Ä–∏–±—ã–ª—å/–º–µ—Å:</strong> –°—Ä–µ–¥–Ω—è—è —á–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å, –∫–æ—Ç–æ—Ä—É—é –≤—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü –ø–æ—Å–ª–µ —É–ø–ª–∞—Ç—ã –≤—Å–µ—Ö —Ä–∞—Å—Ö–æ–¥–æ–≤ –∏ –Ω–∞–ª–æ–≥–æ–≤.</p>
                        <p><strong>–ë–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å:</strong> –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Ä—É—á–∫–∞ –≤ –º–µ—Å—è—Ü, –ø—Ä–∏ –∫–æ—Ç–æ—Ä–æ–π –≤—ã —Ä–∞–±–æ—Ç–∞–µ—Ç–µ "–≤ –Ω–æ–ª—å", –Ω–µ –Ω–µ—Å—è —É–±—ã—Ç–∫–æ–≤.</p>
                    </div>
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="kpi-card"><p class="text-sm text-gray-500">NPV (5 –ª–µ—Ç)</p><p id="npvValue" class="text-xl font-bold text-blue-700">-</p></div>
                        <div class="kpi-card"><p class="text-sm text-gray-500">–û–∫—É–ø–∞–µ–º–æ—Å—Ç—å</p><p id="pbpValue" class="text-xl font-bold text-blue-700">-</p></div>
                        <div class="kpi-card"><p class="text-sm text-gray-500">–ü—Ä–∏–±—ã–ª—å/–º–µ—Å</p><p id="avgProfitValue" class="text-xl font-bold text-blue-700">-</p></div>
                        <div class="kpi-card"><p class="text-sm text-gray-500">–ë–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å</p><p id="breakevenValue" class="text-xl font-bold text-blue-700">-</p></div>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="chart-container">
                        <h3 class="text-center text-base">P&L: –î–æ—Ö–æ–¥—ã –∏ –ü—Ä–∏–±—ã–ª—å <span class="info-icon" data-target="info-pnl-chart">‚ìò</span></h3>
                        <div class="info-box hidden" id="info-pnl-chart">–≠—Ç–æ—Ç –≥—Ä–∞—Ñ–∏–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–æ–≥–Ω–æ–∑ –≤–∞—à–µ–π –≥–æ–¥–æ–≤–æ–π –≤—ã—Ä—É—á–∫–∏ (—Å–∏–Ω–∏–π) –∏ —á–∏—Å—Ç–æ–π –ø—Ä–∏–±—ã–ª–∏ (–≥–æ–ª—É–±–æ–π) –Ω–∞ 5 –ª–µ—Ç.</div><canvas id="pnlChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 class="text-center text-base">–î–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫ (CF) <span class="info-icon" data-target="info-cf-chart">‚ìò</span></h3>
                        <div class="info-box hidden" id="info-cf-chart">–ö–ª—é—á–µ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫. –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –∫–∞–∫ –Ω–∞–∫–∞–ø–ª–∏–≤–∞—é—Ç—Å—è –≤–∞—à–∏ –¥–µ–Ω—å–≥–∏. –¢–æ—á–∫–∞, –≥–¥–µ –ª–∏–Ω–∏—è –ø–µ—Ä–µ—Å–µ–∫–∞–µ—Ç –Ω–æ–ª—å ‚Äî —ç—Ç–æ –º–æ–º–µ–Ω—Ç –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏ –ø—Ä–æ–µ–∫—Ç–∞.</div><canvas id="cashflowChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm">
                    <div class="flex items-center justify-center mb-4">
                        <h2 class="text-center">AI –ë–∏–∑–Ω–µ—Å-—Å–æ–≤–µ—Ç–Ω–∏–∫</h2>
                        <span id="ai-status-indicator" class="ml-2 text-xl" title="–°—Ç–∞—Ç—É—Å AI-–ø–æ–º–æ—â–Ω–∏–∫–∞">‚ö™</span>
                    </div>
                     <div id="ai-status-tooltip" class="text-center text-sm text-red-600 mb-4 hidden"></div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-2 mb-4">
                        <button id="aiOptimizeBtn" class="ai-button">–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ä–∞—Å—Ö–æ–¥–æ–≤</button>
                        <button id="aiGrowthBtn" class="ai-button">–°—Ç—Ä–∞—Ç–µ–≥–∏—è —Ä–æ—Å—Ç–∞</button>
                        <button id="aiStepsBtn" class="ai-button">–ö–ª—é—á–µ–≤—ã–µ —à–∞–≥–∏</button>
                    </div>
                    <div id="aiAnalysisResult" class="p-3 bg-gray-50 rounded-lg min-h-[120px] text-sm whitespace-pre-wrap"></div>
                </div>
            </div>
        </div>
    </main>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- –ò–ù–î–ò–ö–ê–¢–û–† –ò –ü–†–û–í–ï–†–ö–ê –ö–õ–Æ–ß–ê ---
    const apiKey = "%%GEMINI_API_KEY%%";
    const aiStatusIndicator = document.getElementById('ai-status-indicator');
    const aiStatusTooltip = document.getElementById('ai-status-tooltip');
    const aiButtons = [document.getElementById('aiOptimizeBtn'), document.getElementById('aiGrowthBtn'), document.getElementById('aiStepsBtn')];

    function checkAiStatus() {
        if (apiKey.startsWith("%%") || apiKey === "") {
            aiStatusIndicator.textContent = 'üî¥';
            aiStatusIndicator.title = 'AI-–ø–æ–º–æ—â–Ω–∏–∫ –Ω–µ–∞–∫—Ç–∏–≤–µ–Ω';
            aiStatusTooltip.textContent = 'API-–∫–ª—é—á –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω. –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω–æ–º —Å–∞–π—Ç–µ.';
            aiStatusTooltip.classList.remove('hidden');
            aiButtons.forEach(btn => btn.disabled = true);
        } else {
            aiStatusIndicator.textContent = 'üü¢';
            aiStatusIndicator.title = 'AI-–ø–æ–º–æ—â–Ω–∏–∫ –∞–∫—Ç–∏–≤–µ–Ω';
            aiStatusTooltip.classList.add('hidden');
            aiButtons.forEach(btn => btn.disabled = false);
        }
    }
    // ------------------------------------

    const formatCurrency = (value, compact = false) => new Intl.NumberFormat('ru-RU', { style: 'currency', currency: 'RUB', maximumFractionDigits: 0, notation: compact ? 'compact' : 'standard' }).format(value);

    const toolCategoriesContainer = document.getElementById('tool-categories');
    const toolCategoriesData = [
        { id: 'heavy', name: '–¢—è–∂–µ–ª–æ–µ', count: 10, cost: 150000, rate: 2500, utilization: 12, amortization: 60 },
        { id: 'power', name: '–≠–ª–µ–∫—Ç—Ä–æ', count: 50, cost: 20000, rate: 700, utilization: 15, amortization: 36 },
        { id: 'hand', name: '–†—É—á–Ω–æ–µ', count: 100, cost: 5000, rate: 300, utilization: 10, amortization: 24 }
    ];

    toolCategoriesData.forEach(cat => {
        const div = document.createElement('div');
        div.innerHTML = `<h4 class="font-semibold text-gray-700 text-sm mt-2">${cat.name}</h4><div class="grid grid-cols-4 gap-2 text-xs"><div><label>–ö–æ–ª-–≤–æ <span class="info-icon" data-target="info-${cat.id}-count">‚ìò</span></label><input type="number" id="${cat.id}Count" value="${cat.count}" class="w-full p-1 border rounded"></div><div><label>–¶–µ–Ω–∞ ‚ÇΩ <span class="info-icon" data-target="info-${cat.id}-cost">‚ìò</span></label><input type="number" id="${cat.id}Cost" value="${cat.cost}" class="w-full p-1 border rounded"></div><div><label>–ê—Ä–µ–Ω–¥–∞/–¥–µ–Ω—å ‚ÇΩ <span class="info-icon" data-target="info-${cat.id}-rate">‚ìò</span></label><input type="number" id="${cat.id}Rate" value="${cat.rate}" class="w-full p-1 border rounded"></div><div><label>–î–Ω–µ–π/–º–µ—Å <span class="info-icon" data-target="info-${cat.id}-util">‚ìò</span></label><input type="number" id="${cat.id}Utilization" value="${cat.utilization}" class="w-full p-1 border rounded"></div></div><div id="info-${cat.id}-count" class="info-box hidden">–°–∫–æ–ª—å–∫–æ –µ–¥–∏–Ω–∏—Ü —ç—Ç–æ–≥–æ —Ç–∏–ø–∞ –≤—ã –ø–ª–∞–Ω–∏—Ä—É–µ—Ç–µ –∑–∞–∫—É–ø–∏—Ç—å.</div><div id="info-${cat.id}-cost" class="info-box hidden">–°—Ä–µ–¥–Ω—è—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞–∫—É–ø–∫–∏ –æ–¥–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã.</div><div id="info-${cat.id}-rate" class="info-box hidden">–¶–µ–Ω–∞ —Å–¥–∞—á–∏ –≤ –∞—Ä–µ–Ω–¥—É –æ–¥–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã –Ω–∞ –æ–¥–∏–Ω –¥–µ–Ω—å.</div><div id="info-${cat.id}-util" class="info-box hidden">–ö–ª—é—á–µ–≤–æ–π –ø–∞—Ä–∞–º–µ—Ç—Ä! –°–∫–æ–ª—å–∫–æ –¥–Ω–µ–π –≤ –º–µ—Å—è—Ü –∫–∞–∂–¥–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –±—É–¥–µ—Ç –≤ –∞—Ä–µ–Ω–¥–µ.</div>`;
        toolCategoriesContainer.appendChild(div);
    });

    const defaultOptions = { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { ticks: { callback: (v) => formatCurrency(v, true) } } } };
    const pnlChart = new Chart(document.getElementById('pnlChart').getContext('2d'), { type: 'bar', data: { labels: [], datasets: [{ label: '–í—ã—Ä—É—á–∫–∞', data: [], backgroundColor: '#93c5fd' }, { label: '–ß–∏—Å—Ç–∞—è –ø—Ä–∏–±—ã–ª—å', data: [], backgroundColor: '#3b82f6' }] }, options: defaultOptions });
    const cashflowChart = new Chart(document.getElementById('cashflowChart').getContext('2d'), { type: 'line', data: { labels: [], datasets: [{ label: '–ù–∞–∫–æ–ø–ª–µ–Ω–Ω—ã–π CF', data: [], borderColor: '#1e3a8a', fill: true, backgroundColor: 'rgba(59, 130, 246, 0.1)', tension: 0.1 }] }, options: defaultOptions });

    const hybridToggle = document.getElementById('hybridModelToggle');
    const downtimeSettings = document.getElementById('downtimeSettings');
    const downtimeSlider = document.getElementById('downtimeSlider');
    const downtimeValue = document.getElementById('downtimeValue');

    hybridToggle.addEventListener('change', () => { downtimeSettings.classList.toggle('hidden', !hybridToggle.checked); calculateAndRender(); });
    downtimeSlider.addEventListener('input', () => { downtimeValue.textContent = `${downtimeSlider.value}%`; calculateAndRender(); });
    downtimeValue.textContent = `${downtimeSlider.value}%`;

    document.querySelectorAll('.info-icon').forEach(icon => { icon.addEventListener('click', () => { const targetId = icon.getAttribute('data-target'); document.getElementById(targetId).classList.toggle('hidden'); }); });

    let lastCalculationResult = null;
    function calculateAndRender() {
        const inputs = { isHybrid: hybridToggle.checked, downtimePercent: downtimeSlider.value / 100, categories: [], rentCost: parseFloat(document.getElementById('rentCost').value), employeesCount: parseFloat(document.getElementById('employeesCount').value), avgSalary: parseFloat(document.getElementById('avgSalary').value), marketingCost: parseFloat(document.getElementById('marketingCost').value), repairCostPercent: parseFloat(document.getElementById('repairCostPercent').value) / 100, taxRate: parseFloat(document.getElementById('taxRate').value) / 100 };
        toolCategoriesData.forEach(cat => { inputs.categories.push({ ...cat, count: parseFloat(document.getElementById(`${cat.id}Count`).value), cost: parseFloat(document.getElementById(`${cat.id}Cost`).value), rate: parseFloat(document.getElementById(`${cat.id}Rate`).value), utilization: parseFloat(document.getElementById(`${cat.id}Utilization`).value) }); });

        let totalCapex = 0;
        inputs.categories.forEach(cat => { totalCapex += cat.count * cat.cost; });
        const monthlyFOT = inputs.employeesCount * inputs.avgSalary;
        const monthlyFixedOpex = inputs.rentCost + monthlyFOT * 1.302 + inputs.marketingCost;
        const monthlyResults = [];
        for (let i = 0; i < 60; i++) {
            let monthlyRevenue = 0, monthlyAmortization = 0;
            inputs.categories.forEach(cat => {
                let potentialRevenue = cat.count * cat.rate * cat.utilization;
                monthlyRevenue += inputs.isHybrid ? potentialRevenue * inputs.downtimePercent : potentialRevenue;
                if (i < cat.amortization) monthlyAmortization += (cat.count * cat.cost) / cat.amortization;
            });
            const ebt = monthlyRevenue - (monthlyFixedOpex + monthlyRevenue * inputs.repairCostPercent) - monthlyAmortization;
            const netProfit = ebt > 0 ? ebt * (1 - inputs.taxRate) : ebt;
            monthlyResults.push({ revenue: monthlyRevenue, netProfit, cashFlow: netProfit + monthlyAmortization });
        }
        const yearlyResults = [];
        for (let i = 0; i < 5; i++) { const yearSlice = monthlyResults.slice(i * 12, (i + 1) * 12); yearlyResults.push({ revenue: yearSlice.reduce((s, m) => s + m.revenue, 0), netProfit: yearSlice.reduce((s, m) => s + m.netProfit, 0) }); }
        let cumulativeCF = -totalCapex, pbpMonths = -1;
        const cumulativeCFData = [cumulativeCF];
        for (let i = 0; i < 60; i++) { cumulativeCF += monthlyResults[i].cashFlow; cumulativeCFData.push(cumulativeCF); if (cumulativeCF > 0 && pbpMonths === -1) pbpMonths = i + 1; }
        const npv = cumulativeCFData[60];
        const avgMonthlyProfit = monthlyResults.reduce((s, m) => s + m.netProfit, 0) / 60;
        const breakeven = monthlyFixedOpex / (1 - inputs.repairCostPercent);
        
        lastCalculationResult = { isHybrid: inputs.isHybrid, downtimePercent: inputs.downtimePercent, totalCapex, avgMonthlyProfit, pbp: pbpMonths > 0 ? `${pbpMonths} –º–µ—Å.` : '> 5 –ª–µ—Ç', breakeven, npv, marketingCost: inputs.marketingCost, fot: monthlyFOT, revenue: monthlyResults[0].revenue };
        
        document.getElementById('npvValue').textContent = formatCurrency(npv, true);
        document.getElementById('pbpValue').textContent = lastCalculationResult.pbp;
        document.getElementById('avgProfitValue').textContent = formatCurrency(avgMonthlyProfit, true);
        document.getElementById('breakevenValue').textContent = formatCurrency(breakeven, true);
        document.getElementById('totalCapexSummary').textContent = formatCurrency(totalCapex);
        document.getElementById('totalOpexSummary').textContent = formatCurrency(monthlyFixedOpex);

        const years = yearlyResults.map((_, i) => `–ì–æ–¥ ${i+1}`);
        pnlChart.data.labels = years; pnlChart.data.datasets[0].data = yearlyResults.map(y => y.revenue); pnlChart.data.datasets[1].data = yearlyResults.map(y => y.netProfit); pnlChart.update();
        cashflowChart.data.labels = Array.from({length: 61}, (_, i) => i); cashflowChart.data.datasets[0].data = cumulativeCFData; cashflowChart.update();
    }

    async function getAiAnalysis(promptType) {
        const aiResultDiv = document.getElementById('aiAnalysisResult');
        if (!lastCalculationResult) { aiResultDiv.innerHTML = '–°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ –º–æ–¥–µ–ª—å.'; return; }
        aiResultDiv.innerHTML = `<div class="flex justify-center items-center"><div class="spinner w-6 h-6 border-2 rounded-full"></div><p class="ml-2">AI-—Å–æ–≤–µ—Ç–Ω–∏–∫ –¥—É–º–∞–µ—Ç...</p></div>`;
        
        const { isHybrid, downtimePercent, pbp, npv, breakeven, marketingCost, fot, revenue } = lastCalculationResult;
        const modelType = isHybrid ? `–≥–∏–±—Ä–∏–¥–Ω–∞—è –º–æ–¥–µ–ª—å (—Å—Ç—Ä–æ–π–∫–∞ + –∞—Ä–µ–Ω–¥–∞ —Å ${Math.round(downtimePercent*100)}% –ø—Ä–æ—Å—Ç–æ—è)` : '–º–æ–¥–µ–ª—å —á–∏—Å—Ç–æ–π –∞—Ä–µ–Ω–¥—ã';
        const prompts = {
            optimize: `System: –¢—ã - –æ–ø—ã—Ç–Ω—ã–π –±–∏–∑–Ω–µ—Å-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –∏–∑ –ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞. –ì–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç–æ –∏ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏.\nUser: –ú–æ–π –±–∏–∑–Ω–µ—Å (${modelType}) —Ç—Ä–∞—Ç–∏—Ç –≤ –º–µ—Å—è—Ü ${formatCurrency(fot)} –Ω–∞ –∑–∞—Ä–ø–ª–∞—Ç—ã –∏ ${formatCurrency(marketingCost)} –Ω–∞ —Ä–µ–∫–ª–∞–º—É. –í—ã—Ä—É—á–∫–∞ ${formatCurrency(revenue)}. –ü–æ–¥—Å–∫–∞–∂–∏ –ø–∞—Ä—É –∏–¥–µ–π, –∫–∞–∫ –º–æ–∂–Ω–æ —Å–æ–∫—Ä–∞—Ç–∏—Ç—å —ç—Ç–∏ —Ä–∞—Å—Ö–æ–¥—ã, –Ω–µ –ø–æ—Ç–µ—Ä—è–≤ –≤ –∫–∞—á–µ—Å—Ç–≤–µ?`,
            growth: `System: –¢—ã - –æ–ø—ã—Ç–Ω—ã–π –±–∏–∑–Ω–µ—Å-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –∏–∑ –ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞. –ì–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç–æ –∏ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏.\nUser: –ú–æ–π –ø—Ä–æ–µ–∫—Ç (${modelType}) –∏–º–µ–µ—Ç –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å ${pbp} –∏ NPV ${formatCurrency(npv)}. –ö–∞–∫–∏–µ –µ—Å—Ç—å –Ω–µ–æ—á–µ–≤–∏–¥–Ω—ã–µ —Å–ø–æ—Å–æ–±—ã –≤ –ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–µ, —á—Ç–æ–±—ã —É—Å–∫–æ—Ä–∏—Ç—å —Ä–æ—Å—Ç –∏ –±—ã—Å—Ç—Ä–µ–µ –æ–∫—É–ø–∏—Ç—å –≤–ª–æ–∂–µ–Ω–∏—è?`,
            steps: `System: –¢—ã - –æ–ø—ã—Ç–Ω—ã–π –±–∏–∑–Ω–µ—Å-–Ω–∞—Å—Ç–∞–≤–Ω–∏–∫ –∏–∑ –ê—Ä—Ö–∞–Ω–≥–µ–ª—å—Å–∫–∞. –ì–æ–≤–æ—Ä–∏ –ø—Ä–æ—Å—Ç–æ –∏ –ø–æ-—á–µ–ª–æ–≤–µ—á–µ—Å–∫–∏.\nUser: –Ø –∑–∞–ø—É—Å–∫–∞—é –ø—Ä–æ–∫–∞—Ç (${modelType}) —Å –æ–∫—É–ø–∞–µ–º–æ—Å—Ç—å—é ${pbp} –∏ —Ç–æ—á–∫–æ–π –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç–∏ ${formatCurrency(breakeven)}. –ù–∞–∑–æ–≤–∏ 3 —Å–∞–º—ã—Ö –≥–ª–∞–≤–Ω—ã—Ö –¥–µ–ª–∞, –∫–æ—Ç–æ—Ä—ã–µ –Ω—É–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –≤ –ø–µ—Ä–≤—ã–π –≥–æ–¥, —á—Ç–æ–±—ã –±–∏–∑–Ω–µ—Å —Ç–æ—á–Ω–æ –≤–∑–ª–µ—Ç–µ–ª.`
        };
        const [systemInstruction, userQuery] = prompts[promptType].split('\nUser:');
        try {
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
            const payload = { contents: [{ parts: [{ text: userQuery.trim() }] }], systemInstruction: { parts: [{ text: systemInstruction.replace('System:', '').trim() }] }, };
            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) throw new Error(`API error: ${response.status}`);
            const result = await response.json();
            const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
            aiResultDiv.innerHTML = text ? text.replace(/\*\*(.*?)\*\*/g, '<strong class="font-bold">$1</strong>').replace(/-\s(.*?)(?:\n|$)/g, '<li class="ml-4 list-disc">$1</li>') : '–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç AI.';
        } catch (error) { console.error("Gemini API Error:", error); aiResultDiv.textContent = '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ AI-—Å–µ—Ä–≤–∏—Å—É.'; }
    }

    document.querySelectorAll('input').forEach(input => input.addEventListener('input', calculateAndRender));
    document.getElementById('aiOptimizeBtn').addEventListener('click', () => getAiAnalysis('optimize'));
    document.getElementById('aiGrowthBtn').addEventListener('click', () => getAiAnalysis('growth'));
    document.getElementById('aiStepsBtn').addEventListener('click', () => getAiAnalysis('steps'));
    
    checkAiStatus();
    calculateAndRender();
});
</script>

</body>
</html>
